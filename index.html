<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时汇率显示</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
            background-color: #000;
            color: #fff;
        }

        /* 父容器，使用flexbox确保内容排列 */
        .rate-container {
            display: flex;
            justify-content: center;  /* 中心对齐 */
            align-items: center;
            font-size: 50px;  /* 增大字体大小 */
            margin-top: 20px; /* 上边距 */
            margin-bottom: 5px; /* 减少汇率和图表之间的间隙 */
        }

        /* 时间的样式 */
        .update-time {
            font-size: 30px;  /* 增大时间字体 */
            color: rgb(255, 255, 255);
            margin-top: 20px; /* 时间和图表之间的间距 */
        }

        /* 汇率的样式 */
        .rate {
            font-weight: bold;
            color: #fff;
            text-align: center;
        }

        /* 箭头的样式 */
        .arrow {
            font-size: 50px;  /* 增大箭头字体 */
            font-weight: bold;
            margin-left: 10px;
            vertical-align: middle;
        }

        .up {
            color: rgb(255, 17, 0);  /* 上升箭头红色 */
        }

        .down {
            color: rgb(3, 204, 16);  /* 下降箭头绿色 */
        }

        .no-change {
            color: white;  /* 没有变化时白色 */
        }

        /* 图表的样式 */
        canvas {
            margin-top: 5px;  /* 减小图表上方的间距 */
            width: 100%;
            height: 40vh;  
        }

        @media (max-width: 480px) {  
            .rate {
                font-size: 40px;
            }
            .update-time {
                font-size: 25px;
            }
            canvas {
                height: 30vh;  
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- 汇率和箭头显示在一行，居中 -->
    <div class="rate-container">
        <div class="rate" id="exchange-rate">加载中...</div>
        <div class="arrow" id="rate-arrow"></div>
    </div>

    <!-- 走势图 -->
    <canvas id="exchange-rate-chart" width="400" height="200"></canvas>

    <!-- 时间显示在走势图下方 -->
    <div class="update-time" id="update-time">加载中...</div>

    <script>
        let chartInstance = null;
        let times = [];
        let prices = [];
        let lastRate = null;

        // 获取汇率数据
        function fetchExchangeRate() {
            const proxyUrl = "https://corsproxy.io/?url=";  // 使用corsproxy.io作为代理
            const targetUrl = "https://finance.pae.baidu.com/vapi/v1/getquotation?group=huilv_minute&need_reverse_real=1&code=USDCNH";
            const url = proxyUrl + encodeURIComponent(targetUrl);  // 确保URL正确编码

            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.timeout = 5000;  // 设置超时时间

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    if (data.Result && data.Result.cur && data.Result.cur.price !== undefined) {
                        const currentRate = parseFloat(data.Result.cur.price);
                        const updateTime = data.Result.update.text;
                        const ratio = parseFloat(data.Result.cur.ratio);
                        updateRateDisplay(currentRate, updateTime, ratio);
                        updateChart(data.Result.newMarketData);
                    } else {
                        showError("无法获取数据，请稍后重试。");
                    }
                } else {
                    showError("网络响应失败");
                }
            };

            xhr.onerror = function() {
                showError("发生网络错误");
            };

            xhr.ontimeout = function() {
                showError("请求超时");
            };

            xhr.send();
        }

        // 更新汇率显示
        function updateRateDisplay(currentRate, updateTime, ratio) {
            const currentDate = new Date();
            const formattedTime = currentDate.getMonth() + 1 + '-' +
                currentDate.getDate().toString().padStart(2, '0') + 
                ' ' + 
                currentDate.getHours().toString().padStart(2, '0') + ':' + 
                currentDate.getMinutes().toString().padStart(2, '0') + ':' + 
                currentDate.getSeconds().toString().padStart(2, '0');

            document.getElementById("update-time").innerHTML = formattedTime;

            if (isNaN(currentRate) || currentRate === 0) {
                currentRate = 0;
            }

            const formattedRate = currentRate.toFixed(4);
            document.getElementById("exchange-rate").textContent = formattedRate;

            let rateColor = '#fff';
            if (ratio > 0) {
                rateColor = 'rgb(255, 17, 0)';
            } else if (ratio < 0) {
                rateColor = 'rgb(3, 204, 16)';
            }
            document.getElementById("exchange-rate").style.color = rateColor;

            let rateArrowClass = 'no-change';
            let arrowSymbol = '';
            if (lastRate !== null) {
                if (currentRate > lastRate) {
                    rateArrowClass = 'up';
                    arrowSymbol = '&#8593;';
                } else if (currentRate < lastRate) {
                    rateArrowClass = 'down';
                    arrowSymbol = '&#8595;';
                } else {
                    rateArrowClass = 'no-change';
                    arrowSymbol = '-';
                }
            }

            document.getElementById("rate-arrow").className = `arrow ${rateArrowClass}`;
            document.getElementById("rate-arrow").innerHTML = arrowSymbol;

            lastRate = currentRate;
        }

        // 更新图表
        function updateChart(marketData) {
            const newTimes = [];
            const newPrices = [];

            marketData.marketData.forEach(item => {
                const entries = item.p.split(';');
                entries.forEach(entry => {
                    const fields = entry.split(',');
                    newTimes.push(fields[1]);
                    newPrices.push(parseFloat(fields[2]));
                });
            });

            // 将时间数据增加至次日6时
            const nextDay = new Date();
            nextDay.setHours(30, 0, 0);  
            newTimes.push(nextDay.toISOString().slice(11, 16)); 

            times = newTimes;
            prices = newPrices;

            if (chartInstance) {
                chartInstance.destroy();
            }

            plotChart(times, prices);
        }

        // 绘制图表
        function plotChart(times, prices) {
            const ctx = document.getElementById('exchange-rate-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times,
                    datasets: [{
                        data: prices,
                        borderColor: 'rgb(75, 192, 192)',  /* 图表线条颜色 */
                        borderWidth: 3,  /* 增加线条宽度 */
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    animations: {
                        tension: {
                            duration: 0,
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            labels: times,
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10  
                            },
                        },
                        y: {
                            ticks: {
                                beginAtZero: false,
                                stepSize: 0.5
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // 每10秒钟获取一次汇率数据
        setInterval(fetchExchangeRate, 2000);  
        setInterval(updateChart, 60000);  
        fetchExchangeRate();
    </script>

</body>
</html>
